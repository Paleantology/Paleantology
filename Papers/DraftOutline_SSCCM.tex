\documentclass[]{article}
\usepackage{amsmath} 
\usepackage{natbib}

\begin{document}

\title{Site-Heterogeneous Character Change Models for Morphology}
\author{Wright, Pett, Students, Heath}
\date{Today}
\maketitle

\section{Abstract}

Morphological data is challenging to model due to the arbitrary properties of morphological character codings. 
The Mk model, a generalization of the Jukes-Cantor model, assumes a that there is an equal rate of forward and backwards transitions in morphological traits.
In this study, we used an expanded combined set of two ant (Formicidae) data matrices, composed of one extinct-extant matrix and one extant matrix to estimate a phylogeny for the group.
We use this large matrix to explore methods for relaxing the transition rate symmetry of the Mk model, and introduce the Site Heterogeneous Discrete Morphology (SHDM) to allow equilibrium character frequencies to vary. 
Using a symmetric Dirichlet process as a prior of this modeling allows for the difference in stationary frequency of characters to be expressed more accurately than if expressed with a parsimony method such a generalized Jukes-Cantor model.

\section{Introduction}
\subsection{Bayesian Modeling of Morphology}
	Recent interest in using Bayesian methods to model morphological evolution to estimate phylogenetic trees has spurred many studies into how well the existing toolkit performs, particularly in relation to parsimony methods.
	However, there has been little work expanding the toolkit of methods available to researchers estimating trees from morphological data. 
	The most common way to perform likelihood or Bayesian phylogenetic analysis using morphological data is by applying a model of morphological evolution called the Mk model.
	Many workers using morphological data have raised questions about the realism of this model.
	In this paper, we will discuss methodological advancements aimed at improving the realism of the model. \par
	The Mk model was introduced by Lewis in 2001.
	As a generalization of the Jukes-Cantor model, it makes the same set of assumptions: that change between any two states is equally likely, that the stationary character frequencies of every character are the same, and that each character is always in one of \textit{k} known states.
	The model also makes the Markovian assumption that a character can change instantaneously, regardless of previous states, or multiply along a branch. 
	Any one of these assumptions may strike a reader as problematic for their particular dataset. \par
	Heterogeneity in the evolutionary process is difficult to accommodate in morphological data. 
	Making concrete \textit{a priori} statements about the relative probabilities of transitions between character states in a morphological character matrix is challenging. 
	Unlike a matrix of nucleotide characters, in which a state carries common meaning across sites, a `1' state at one character may represent a derived state requiring many underlying genetic changes.
	At another character, it could represent a derived state requiring only one underlying genetic change.
	Characters can also differ in meanings with respect to whether they are coded as ancestral or derived.
	If a matrix was coded with respect to specific outgroups, often the outgroup will mostly have a `0' state, with ingroup taxa having typically having state `1' or higher.
	This may not be the case for composite matrices or matrices coded without specific reference to an outgroup or character polarities.
	This lack of common meaning limits a researcher's ability to specify a common mechanism.
	This has complicated the ability to specify $\alpha$ parameters to the Q-matrix \textit{a priori}.
	This is a stark contrast to molecular data, in which base pairs or amino acid residues are generally assumed to have similar properties across an alignment. \par
Prior work extending the Mk model has focused on relaxing the assumption of equal character frequencies at stationarity.
MrBayes implemented a parameter called the Symmetric Dirichlet Hyperprior, which allowed users to place a prior or hyperprior on state frequencies. 
The probability of observing a change in a character is dependent not only on the probability of change from this character to another, but on the frequency of the starting character.
Even if a character has a low probability of changing, change in that character may still be observed many times if the stationary frequency of that character is high (i.e., the character is observed many times). 
Likewise, a highly-probable change may be seen relatively rarely if the starting character is observed rarely. 
Therefore, relaxing the assumption of equal stationary frequencies has been a way of changing the probabilities of observing different changes without making strong \textit{a priori} statements about transition probabilities. \par
In the case of binary data, MrBayes implemented a Beta prior (the Dirichlet is a generalization of the Beta distribution for non-binary data), which operated in a fashion similar to gamma-distributed rate variation: the distribution is discretized into a user-specified number of categories, the median forward and backward transition rate are calculated for each category, and the likelihood of the character is calculated over each category and summed to form the total likelihood. 
For binary data, the state frequencies are integrated out of the likelihood, making the symmetric Dirichlet hyperprior actually a prior.
For multistate data, the state frequencies are drawn from a Dirichlet distribution, as the Dirichlet is a multi-state generalization of the Beta distribution.
The parameter was referred to as a hyperprior because users can place a distribution on the parameter to the Beta distribution, and because the state frequencies are not integrated out of the likelihood function for multistate data. 
As implemented in MrBayes, the Beta distribution was assumed to be symmetric, meaning that if there was a class of characters for which the stationary frequency of 0 is high, there would also be corresponding class of characters for which the stationary frequency of 1 is high.\par
This is a very useful model extension for morphological evolution.
There are clear contexts to improve this concept by borrowing from the molecular literature.
The CAT model of Lartillot represents one way forward. 
This model, implemented in PhyloBayes, uses a Dirichlet process prior to assign individual sites to categories, which differ in their stationary frequencies. 
In this model, the number of such categories that describe the data is a free parameter. 
The use of a Dirichlet prior allows for flexibility in the number of states, as opposed to a Beta prior which is limited to binary data.
However, many datasets that have been analyzed under the CAT model are phylogenomic datasets of thousands of loci, as compared to data-limited morphology datasets.\par
In RevBayes, we have implemented a number of useful extensions to the Dirichlet prior of MrBayes, and a constrained version of the CAT model. 
Our extension to the symmetric Beta prior allows for the Beta distribution to be asymmetrical.
This removes the need for there to be equal numbers of characters with high stationary frequencies for a character state as there are characters with low stationary frequencies for that same character state.
Our CAT-like model (hereafter Site-Heterogeneous Discrete Morphology (SDHM) model) is a finite mixture model that allows characters to fit into a user-defined number of character categories that differ in their stationary frequencies. 
The bins draw their stationary frequencies from a Dirichlet to accommodate multistate data. 

\subsection{Morphological Phylogeny of the Formicidae}

To test the efficacy of our analytical techniques, we use an ant dataset created from datasets from Barden and Grimaldi and one from Keller.
Ants are ecologically crucial organisms as both interacting partners for a variety of plants and animals, and as shapers of the ecosystem via soil cycling and nest building.
As such, they have attracted much work in the world of molecular systematics.
Ants have also have a rich fossil record, with most subfamilies being represented. 
This fossil record has been used for systematic work, as well as a variety of other ecological and evolutionary questions.\par
The monophyly of major subfamilies has been consistently supported by most molecular studies, with the exception of the Cerapachyinae. 
Molecular systematics had originally shaken up the ant tree of life considerably, breaking up clades considered to be monophyletic based on morphological work.
For example, based on morphological work, six current subfamilies had been previously considered to be a single subfamily, the Ponerinae, until molecular evidence indicated that two of the clades (Ectatomminae and Heteroponerinae) within that subfamily were demonstrated to be more closely related to other ants on the tree.
The Ponerinae was then broken into six distinct subfamilies, one of which is also called Ponerinae. 
Recent molecular work has continued to support these six subfamilies as monophyletic, though their relationships to one another remain poorly supported. \par
Excellent morphological matrices on the ingroup of the Formicidae have been available since the early '90s. 
Recent morphological matrices have expanded the sampling of ants from in the large Ponerine family, which was previously undersampled.
Sampling of fossil ants was also expanded to include specimens from the Cretaceous.
These ants were concluded to be stem lineages, and some did not demonstrate any particular taxonomic affinity based on character data and phylogenetic placement. 
Even with expanded taxon sampling in the Ponerinae, there is still conflict between the molecular and morphological estimates of phylogenetic relationships. \par
In this study, we combine the extant matrices of Keller, and the extinct-extant matrix of Barden and Grimaldi to expand the taxon and character sampling.  
This dataset has interesting properties.
Because there are stem ant lineages represented, there are taxa that have characteristics that are lost after the divergence of the stem lineages.
This extremely one-sided loss structure violates the Mk model assumption of equal transition rates. 
We would expect for these characters to be better modeled by a model that can accommodate asymmetrical transition rates.
Some apomorphies of the ant group are also gained after the divergence of the stem lineages, which also violates the assumption of equal change probabilities.
Because of these model violations, this dataset is an excellent test case for models that relax assumptions of the Mk model. \par
We use Bayes Factor model selection to assess the fit of these relaxed models to the data.
Using this dataset, we strongly support that the use of models that relax key assumptions of the Mk model can greatly improve the fit of the model to the data.
We also perform simulations to demonstrate that the true number of transition rate asymmetry categories is detectable from the data.

\section{Methods}

\subsection{Modeling site-heterogeneous state frequencies}

We model morphological character evolution using the Mk model \citep{lewis2001likelihood}, and additionally account for site-specific heterogeneity in substitution rates among character states by allowing the equilibrium state frequencies $\pi$ to vary among sites, such that each site $i$ has its own state frequency vector $\pi_i$.

\subsubsection{Discretized beta model}
We model site-specific binary state frequencies by assuming the state frequencies $\pi_i$ are drawn from a 2-dimensional Dirichlet (Beta) prior distribution with hyperparameters $\alpha,\beta$.
Then, the likelihood of the data $D$ is computed by marginalizing over the value for $\pi_i$ at each site.

\begin{equation} \label{continuous-likelihood}
f(D\mid \alpha,\beta) = \prod_{i=1}^n\int_0^1 f(D_i \mid \pi_i)f(\pi_i \mid \alpha,\beta)d\pi_i
\end{equation}

To simplify the computation, we approximate this integrated likelihood by assuming $\pi_i$ is drawn from a mixture distribution, where the mixture categories are defined deterministically by discretizing a Beta distribution into $k$ bins whose boundaries are defined using $k-1$ quantiles.
The the value of mixture category $j$ is indicated by $\phi_j$ and is computed as the interquantile median of the $j$-th bin.
In other words, $\phi_j = I^{-1}_{(2j-1)/2k}(\alpha,\beta)$, where $I_x(\alpha,\beta)$ is the regularized incomplete Beta function.
The mixing proportion is $1/k$ for each category.
Then the likelihood is computed by summing over the $k$ discrete mixture categories for $\pi_i$ at each site.

\begin{equation} \label{discretized-likelihood}
f(D\mid \alpha,\beta) = \prod_{i=1}^n\frac{1}{k}\sum_{j=1}^k f(D_i \mid \pi_i = \phi_j)
\end{equation}

Note that in the limit as the number of mixture categories approaches infinity, equation \ref{discretized-likelihood} is identical to equation \ref{continuous-likelihood}.

\subsubsection{Site-heterogeneous multistate model}

When analyzing multistate character data with $S$ character states, we assume the state frequencies $\pi_i$ at each site $i$ are drawn from a Dirichlet distribution with concentration parameters $\alpha_1,\ldots,\alpha_S$.
Again, we use a mixture distribution to simplify the computation, but instead of defining the mixture categories using a discretized Dirichlet distribution, the value $\delta_j$ of mixture category $j$ is assumed to be drawn from the same underlying Dirichlet distribution with parameters $\alpha_1,\ldots,\alpha_S$.
The mixing proportions are $\theta_j$, which are themselves drawn from a uniform Dirichlet prior distribution.

$$f(D\mid \delta_1,\ldots,\delta_k,\theta_1,\ldots,\theta_k) = \prod_{i=1}^n \sum_{j=1}^k  f(D_i \mid \pi_i = \delta_j)\theta_j$$

\subsection{Data Matrices}
\subsubsection{Empirical Matrices}
Several large and well-documented ant matrices were used in this study.
The first was that of Keller (2011). 
This matrix is of extant ant groups. 
Keller's matrix was collected with special attention to the poneromorph subgroups (Amblyoponinae, Ectatomminae,Heteroponerinae, Paraponerinae, Ponerinae, and Proceratiinae) and has 139 characters and 105 taxa.
The matrix is highly complete for a morphological dataset, with about 60\% of cells being filled.
Of the total character set, 100 characters were binary and 39 characters were multistate.
Because of the scope of Keller's study, the taxon sampling is biased towards the poneromorphs, and away from the other ant subfamilies, including large subfamilies such as the Dolichoderinae and the Formicinae. \par
We also used data from Barden and Grimaldi (2015). 
This matrix contained both extant and extinct ants, and was collected in order to place stem ants from the Cretaceous period.
One crown ant amber fossil, \textit{Kyromyrma neffi}, was included in this matrix, but the key feature of this matrix is the sampling of the stem group, including multiple samples from the \textit{Gerontoformica} genus.
This matrix also expands sampling in the non-ponerine groups that are underrepresented in the Keller matrix.
The Barden-Grimaldi matrix contained 42 characters and 41 taxa. 
Of these characters, 26 were binary.\par
In order to achieve maximum coverage, we merged these character matrices.
The taxonomic overlap between the two was 11 taxa, and all subfamilies of the Formicidae except the extinct Formiciinae were represented in the matrix. 
Eleven characters were represented in both matrices without any recoding, and both matrices had many characters that were inapplicable to the other matrices.
Inapplicable characters were left in the matrix due to their ability to resolve bipartitions in the the authors' respective groups of interest. \par
Six characters were recoded to make the character states uniform between the two matrices.
Most of these changes simply involved changing the terminology used in reference to the character states.
For example, Barden and Grimaldi's character 15 is the same as Keller's character 47, but the two matrices had inverse character codings relative to one another.
The remainder of the changes were changing binary characters to a multistate in cases where one author had more states than the other. 
We will refer to this dataset as the combined dataset. \par
We tested the SHDM model on both binary and binary + multistate datasets.
First, to test the model on binary-only datasets, we used Barden and Grimaldi's dataset with the multistate characters removed.
This dataset was chosen because the dataset size and completeness is very typical to a morphological dataset, particularly one involving fossils.
We also used the combined matrix, stripped of multistate characters to test the model to look at the effect of estimating a larger tree using more characters.
In both cases, we performed Bayes Factor model fitting to determine how many discrete Beta categories best model the data. \par
To test the full SHDM model, we used both the Barden-Grimaldi dataset and the combined dataset.
In testing the SHDM model, we modeled the binary and multistate characters together.
This allowed us to both examine the impact of allowing character frequencies to be drawn from a Dirichlet, and to examine the effect of adding more data to the phylogenetic question. 
\par
\subsubsection{Model comparison}

The appropriate number of categories $k$ for each of the two empirical datasets was selected by comparing estimates of the marginal likelihood under different values for $k$.
Marginal likelihoods were estimated using the steppingstone sampling method \citep{xie2010improving} implemented in RevBayes.


\subsubsection{Simulated Matrices}

To test the performance of the SHDM model on idealized datasets, we used RevBayes to simulate five sets of 100 replicates of morphological data.
The first two sets of simulations were based on Barden and Grimaldi's dataset size and tree.
Under this set of conditions, datasets of 41 taxa and 42 characters were simulated in RevBayes.
In one set, only binary characters were evolved under the Beta model.
In the other, both binary and mutistate characters were evolved under the Dirichlet prior.
For both datasets, the beta or Dirichlet distribution was discretized into four categories.
\par
The other set of two simulations was based on the full datasets.
One set of 139 binary characters was generated for the full 105 taxa under the binary model; a second set including multistate characters was generated under the SHDM model, with the distribution discretized into four categories.
The tree used to generate the data was the tree estimated from the combined empirical dataset using the SHDM. \par

\subsection{Phylogenetic Analyses}
\subsubsection{Empirical Data}

Trees were estimated from each empirical dataset using multiple models of evolution.
The Mk model was used for each dataset, with an appropriately-sized Q-matrix.
For the binary-only datasets, the binary model was used.
The datasets containing both binary and multistate characters were analyzed using the SHDM, with the dimensionality of the Dirichlet process being equal to the largest number of character states. 
Each dataset was run under several different numbers of discrete state frequency variation categories, from two to six categories.
All datasets were corrected for not observing invariant characters. \par
For the binary datasets, Bayes Factor model fitting was used to assess what the optimal number of discrete categories were.
We used stepping-stone model fitting to calculate the marginal likelihood.
We first ran an MCMC analysis to determine how many generations are required to attain convergence (about one million).
Each of the 75 stepping stones was then run for one million generations.
Due to computational limits, for the multistate datasets, we used the mean of the MCMC distribution to compare across different discretizations of the model. \par


\subsubsection{Simulated Data}

Because the true tree cannot be known from empirical data, we used simulated data to observe the effect this model has on accuracy of estimation, and to see if it is possible to detect the true number of discrete categories of state frequency variation.
To this end, we estimated trees for each replicate under the true model.
We also estimated trees for each replicate under 5 misspecified models: the Mk model, 2 and 3 category models (underparameterized models), and 5 and 6 category models (overparameterized models). 
Estimation was performed in RevBayes under the generating model.\par


\section{Results}

\subsection{Empirical Phylogenetic Analyses}

The marginal likelihood comparisons for the Barden and Grimaldi dataset, when multistate characters are removed can be seen in Fig. 1a.
The marginal likelihood comparisons for the combined dataset with the multistate characters removed can be seen in Fig. 1b.
\textbf{Barden Dataset}
	a) Best fit model?
	b) Tree comparisons, esp. branch lengths. No asc. bias correction + misspecified model, no correction + misspecified model, correction + correct model, correction + misspecified model 
	c) Tree set visualization comparisons
\textbf{Keller Dataset}
	a) Best fit model?
	b) Tree comparisons, esp. branch lengths. No asc. bias correction + misspecified model, no correction + misspecified model, correction + correct model, correction + misspecified model 
	c) Tree set visualization comparisons
\textbf{Combined Dataset}
	a) Best fit model?

	b) Tree comparisons, esp. branch lengths. No asc. bias correction + misspecified model, no correction + misspecified model, correction + correct model, correction + misspecified model 
	c) Tree set visualization comparisons

\subsection{Simulated Phylogenetic Analyses}
\subsubsection{Binary Data}

In the large datasets, underparameterized models have a deleterious impact on the accuracy of phylogenetic analyses. 
However, overparameterized models did not show a similar decrease in accuracy.
In the smaller datasets, accuracy does not seem to be tied to the parameterization of the model. \par

\subsubsection{Multistate Data}

In the large, multistate data sets, accuracy is improved using a correctly-specified model over both over- and underparameterized models. 
In the small datasets, a pattern similar to that of the large binary datasets is observed, in which underparameterization negatively effected accuracy, while overparamterization did not. \par

\section{Discussion}	

The discussion surrounding the incorporation of morphological data into phylogenetic analyses has largely focused on two endpoints on a spectrum: Parsimony and the Mk model \citep{lewis2001likelihood}.
The idea behind parsimony is simple: that each character can have its own tree and length (number of steps) on that tree.
The simplicity of this idea belies the complexity of the implications about character evolution.
Parsimony can be written out as a likelihood model, referred to as the No Common Mechanisms model.
However, it has been demonstrated that this model is so complex, and features so many parameters	that it is never chosen by even a liberal information criterion. \par
In many ways, the Mk model is similar to an unweighted parsimony model, assuming that the transitions between any two states are equally likely.
But the Mk model assumes a common mechanism across sites, a generalized Jukes-Cantor model.
Application of among site rate variation (ASRV) across characters allows characters to have differing rates of evolution, accommodating natural variation in phenotypic characters. 
Allowing the rate of evolution to vary is known to be benefit in phylogenetic analysis \citep{felsenstein78}, and can potentially be more important than an incorrectly-specified model of evolution \citep{lemmon2004importance}.
Previous work in morphological phylogenetics has also highlighted the importance of appropriate assumptions about rate heterogeneity \citep{Harrison2014}.	\par
The model discussed here is an effort to create a similar framework to ASRV, but for the actual model of evolution. 
We may know little about the probability of a particular transition between two character states \textit{a priori}, in the same way that we may know little about the rate of evolution of any particular site. 
Under the discrete Beta model and the SHDM, state frequencies are drawn from either a Beta (binary data) or Dirichlet (multistate data) prior distribution.
The site likelihoods are then computed by marginalizing over the value of the vector of state frequencies, $\pi_i$.
Mechanistically, this is very similar to the way in which ASRV is calculated. \par
In practice, these model allows us to assume multiple possible mechanisms across a single dataset. 
Previous work on similar models in the software MrBayes \citep{Wright2016} has found that the Mk model is supported using steppingstone model selection in about half of phylogenetic datasets tested.
However, for modeling the other half, a single common mechanism is not adequate. 
In this paper, we have implemented the Beta model from MrBayes, and clarified a model for multistate characters to allow modeling of evolution when a single, common mechanism cannot be assumed. \par
Trees estimated from the empirical data under parsimony are extremely incompletely resolved unless clade constraints are used.
This is also the case for our model-based estimations. 
Due to the presence of stem ants the matrices used, particularly those of Barden, would be expected to show multiple models of asymmetric transitions. 
In some characters, we would expect to see a strong signature of loss: stem ants often display characters similar to that of the wasp outgroup, which crown ants do not.
We would expect to see these characters lost, but not regained as expected under the Mk model.
Likewise, due to the presence of ant apomorphies in the crown, we expect to see these characters gained and never lost.
Together, these character classes argue strongly for a symmetric Beta distribution, in which if there is a set of characters with a certain bias (for example, more `0' to `1' transitions), it is expected that there would be another set of characters with an opposite bias. \par
Indeed, each dataset strongly supports the use of a non-Mk model, with differing numbers of categories (Fig. 1).
Why then would a model statistically supported to be a better fit to the data not lead to a more resolved tree?
There are several possible explanations for this.
First, ants are known to have strong convergence within characters.
The group is large and diverse, but fairly morphologically constrained.
While likelihood-based methods are expected to fare better than parsimony when convergence is an issue, they are not perfect and can be mislead, particularly in the presence of model violations such as structured missing data.
Secondly, the dataset is small relative to the number of taxa.
It's possible that there simply isn't enough data to address every split in the tree.
Lastly, I dunno. Morphology what. \par








 \par







\section{Ackno}	

\bibliographystyle{plain}
\bibliography{bibliography}

\end{document}